window.baseUrl="http://www.qhdsx.com:9876/yougo",window.YOU_HUI_BaseUrl="http://joke.qhdsx.com/logistics",angular.module("ionic.ion.autoListDivider",[]).directive("autoListDivider",["$timeout",function(e){var t="";return{link:function(n,r,o){var a=o.autoListDividerValue,i=function(e){return e.slice(0,1).toUpperCase()},l=function(){var e=n.$apply(o.autoListDividerFunction)||i,l=e(a);if(l!=t){var s=angular.element("<div class='item item-divider'>"+l+"</div>");r[0].parentNode.insertBefore(s[0],r[0])}t=l};e(l,0)}}}]);var app=angular.module("starter",["ionic","LogisticModule","UserModule","TasksModule","Directive","services.lp","services.taskservice","services.user","ngCordova"]);app.run(["$ionicPlatform","$interval","UserService",function(e,t,n){e.ready(function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleLightContent(),t(function(){n.setPostManLocation()},3e5)})}]).config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider","$httpProvider",function(e,t,n,r){n.setPlatformConfig("android",{tabs:{style:"standard",position:"bottom"}})}]);var directiveModule=angular.module("Directive",[]);directiveModule.directive("youhuiMapOrder",function(){return{restrict:"E",replace:!0,template:"<div id='allMap'></div>",controller:["$state","$scope","$stateParams","$http","UserService","OrderListService",function(e,t,n,r,o,a){var i={id:n.orderid};a.getOrderDetail(i).then(function(e){if(angular.isObject(e)){var t=e,n=new BMap.Map("allMap");n.addControl(new BMap.ZoomControl);var r=(new BMap.Geocoder,new BMap.Icon("http://121.199.37.124/flj_sz/static/images/ud.png",new BMap.Size(100,120),{imageOffset:new BMap.Size(8,15)})),o=new BMap.Icon("http://121.199.37.124/flj_sz/static/images/uo.png",new BMap.Size(100,120),{imageOffset:new BMap.Size(8,15)}),a=new BMap.Icon("http://121.199.37.124/flj_sz/static/images/up.png",new BMap.Size(100,120),{imageOffset:new BMap.Size(8,15)}),i=JSON.parse(localStorage.getItem("deliverymanlocation")),l=new BMap.Point(i.longitude,i.latitude),s=new BMap.Marker(l,{icon:a});n.addOverlay(s);var c=new BMap.Point(t.sellerlongitude,t.sellerlatitude),d=new BMap.Marker(c,{icon:o});n.addOverlay(d);var u=new BMap.Point(t.buyerlongitude,t.buyerlatitude),p=new BMap.Marker(u,{icon:r});n.addOverlay(p);var f=new BMap.Polyline([l,c],{strokeColor:"blue",strokeWeight:6,strokeOpacity:.5});n.addOverlay(f);var v=new BMap.Polyline([c,u],{strokeColor:"red",strokeWeight:6,strokeOpacity:.5});n.addOverlay(v),n.centerAndZoom(l,15)}})}],link:function(e,t,n){}}}),directiveModule.directive("youhuiMap",function(){return{restrict:"E",replace:!0,template:"<div id='allMap'></div>",controller:function(e,t,n,r,o,a){var i={id:n.taskid};a.queryTaskForDetail(i).then(function(e){if(e.success){var t=e.result,n=new BMap.Map("allMap");n.addControl(new BMap.ZoomControl);var r=new BMap.Geocoder,o=new BMap.Icon("http://121.199.37.124/flj_sz/static/images/uo.png",new BMap.Size(100,120),{imageOffset:new BMap.Size(8,15)}),a=new BMap.Icon("http://121.199.37.124/flj_sz/static/images/up.png",new BMap.Size(100,120),{imageOffset:new BMap.Size(8,15)}),i=JSON.parse(localStorage.getItem("deliverymanlocation")),l=new BMap.Point(i.longitude,i.latitude),s=new BMap.Marker(l,{icon:a});n.addOverlay(s),angular.forEach(t,function(e,t){var a=e.selleraddr;r.getPoint(a,function(e){if(e){var t=new BMap.Polyline([l,e],{strokeColor:"blue",strokeWeight:6,strokeOpacity:.5});n.addOverlay(new BMap.Marker(e,{icon:o})),n.addOverlay(t)}},"")});var c={width:100,height:30,title:"",enableAutoPan:!0},d="地图上有"+t.length+"个运单!",u=new BMap.InfoWindow(d,c);s.addEventListener("click",function(){n.openInfoWindow(u,l)}),setTimeout(function(){n.openInfoWindow(u,l)},200),n.centerAndZoom(l,15)}})},link:function(e,t,n){}}}),directiveModule.directive("youhuiTimeCal",function(){var e={restrict:"EA",replace:!0,transclude:!0,scope:{timeInfo:"=timedetail"},template:"<span>{{timeInfo}}</span>",link:function(e,t,n){var r=function(e){var t=new Date(e.replace(/-/g,"/")),n=new Date,r=parseInt(Math.abs(n-t)),o="",a=parseFloat(r/31536e6);return a>1?o=Math.floor(a)+"年前":(a=parseFloat(r/2592e6),a>1?o=Math.floor(a)+"月前":(a=parseFloat(r/6048e5),a>1?o=Math.floor(a)+"周前":(a=parseFloat(r/864e5),a>1?o=Math.floor(a)+"天前":(a=parseFloat(r/36e5),a>1?o=Math.floor(a)+"小时前":(a=parseFloat(r/6e4),o=a>1?Math.floor(a)+"分钟前":"刚刚"))))),o};e.timeInfo=r(e.timeInfo)}};return e});var logisticModule=angular.module("LogisticModule",[]);logisticModule.controller("MainMenuCtrl",["$state","$scope","$http","UserService",function(e,t,n,r){var o=t.vm={};o.checkuserinfo=function(){console.log("在主菜单中调用数据信息!");var t=r.getDeliveryMan();null!=t&&t||(console.log("useris = "+t),e.go("signin"))},o.checkuserinfo()}]),logisticModule.controller("SignInCtrl",["$state","$scope","$http","UserService",function(e,t,n,r){var o=t.vm={};o.btnsendsms={disabled:!1,text:"获取验证码",count:60},o.user={phone:"",password:"",verfcode:""},o.signin=function(){o.vaildatetext="";var t=o.user.phone;if(null==t||""==t)return void(o.vaildatetext="请您填写手机号码!");var n=!!t.match(/^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/);return 0==n?void(o.vaildatetext="手机号码不正确!"):null==o.user.password||""==o.user.password?void(o.vaildatetext="请您填写注册密码!"):o.user.password.length>=8?void(o.vaildatetext="密码字符长度不能超过8位!"):void r.signIn(o.user).then(function(t){t.success?(localStorage.setItem("deliveryman",JSON.stringify(t.result)),e.go("app.needlist"),console.log("登陆成功 跳转到登陆界面进行登陆")):o.vaildatetext="用户名或密码不正确,请重试!"})}}]),logisticModule.controller("SignUpCtrl",["$cordovaAppVersion","$interval","$state","$scope","$http","UserService",function(e,t,n,r,o,a){var i=r.vm={};i.btnsendsms={disabled:!1,text:"获取验证码",count:60},i.user={phone:"",password:"",verifycode:""},i.sendSms=function(){if(i.vaildatetext="",null==i.user.phone||""==i.user.phone)return void(i.vaildatetext="请您填写手机号码!");var e=i.user.phone,n=!!e.match(/^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/);return 0==n?void(i.vaildatetext="手机号码不正确!"):(i.btnsendsms.disabled=!0,void a.findPhoneOnly(i.user).then(function(e){e.success&&"101"==e.code?a.sendSms(i.user).then(function(e){if(e.success){var n=t(function(){i.btnsendsms.count--,i.btnsendsms.text=i.btnsendsms.count+"秒后重新发送",0==i.btnsendsms.count&&(i.btnsendsms={disabled:!1,text:"获取验证码",count:60},t.cancel(n))},1e3);r.$on("$destroy",function(){t.cancel(n)})}else"101"==e.code?i.vaildatetext="该用户已经存在!":i.vaildatetext="系统问题，请联系客服!",i.btnsendsms.disabled=!1}):i.vaildatetext="该用户手机已经注册!"}))},i.signup=function(){var t=i.user.phone;if(null==t||""==t)return void(i.vaildatetext="请您填写手机号码!");var r=!!t.match(/^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/);return 0==r?void(i.vaildatetext="手机号码不正确!"):null==i.user.password||""==i.user.password?void(i.vaildatetext="请您填写注册密码!"):i.user.password.length>=8?void(i.vaildatetext="密码字符长度不能超过8位!"):null==i.user.verifycode||""==i.user.verifycode?void(i.vaildatetext="请您填写验证码!"):void e.getAppVersion().then(function(e){i.user.appversion=e,a.signUp(i.user).then(function(e){e.success?(console.log("注册成功 跳转到登陆界面进行登陆"),i.vaildatetext="系统注册成功!",a.signIn(i.user).then(function(e){localStorage.setItem("deliveryman",JSON.stringify(e.result)),n.go("signin")})):(console.log("注册失败"),console.log(e))})})}}]),logisticModule.controller("FindPassCtrl",["$interval","$state","$scope","$http","UserService",function(e,t,n,r,o){var a=n.vm={};a.btnsendsms={disabled:!1,text:"获取验证码",count:60},a.user={phone:"",password:"",verfcode:""},a.sendSms=function(){if(a.vaildatetext="",null==a.user.phone||""==a.user.phone)return void(a.vaildatetext="请您填写手机号码!");var t=a.user.phone,r=!!t.match(/^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/);return 0==r?void(a.vaildatetext="手机号码不正确!"):(a.btnsendsms.disabled=!0,void o.findPhoneOnly(a.user).then(function(t){t.success&&"100"==t.code?o.sendSms(a.user).then(function(t){if(t.success){var r=e(function(){a.btnsendsms.count--,a.btnsendsms.text=a.btnsendsms.count+"秒后重新发送",0==a.btnsendsms.count&&(a.btnsendsms={disabled:!1,text:"获取验证码",count:60},e.cancel(r))},1e3);n.$on("$destroy",function(){e.cancel(r)})}else"101"==t.code?a.vaildatetext="该用户已经存在!":a.vaildatetext="系统问题，请联系客服!",a.btnsendsms.disabled=!1}):(a.vaildatetext="该用户手机没有注册过!",a.btnsendsms.disabled=!1)}))},a.findpass=function(){return a.vaildatetext="",null==a.user.password||""==a.user.password?void(a.vaildatetext="请您填写注册密码!"):a.user.password.length>=8?void(a.vaildatetext="密码字符长度不能超过8位!"):void o.getPassWord(a.user).then(function(e){e.success?(a.vaildatetext="修改密码成功，请登陆系统!",t.go("signin")):a.vaildatetext="修改手机密码失败,请联系客服!"})}}]),logisticModule.controller("MineDetailCtrl",["$scope","$http","OrderListService","DeliveryMenService","UserService",function(e,t,n,r,o){var a=o.getConsumer(),i=a.deliverymanid,l={delmanid:i},s=e.vm={};s.man={},s.showDetail=function(e){r.findDeliveryManDetail(e).then(function(e){s.man=angular.extend(a,e)})},s.showDetail(l)}]),logisticModule.controller("LogisticListCtrl",["$scope","$state","$http","$ionicPopup","OrderListService","UserService",function(e,t,n,r,o,a){var i={start:0,flowstate:0,limit:5},l=e.vm={};l.noMoreItemsAvailable=!1,o.clear(),l.loadMore=function(){o.findAllNeedOrder(i).then(function(t){0!=t.length?(l.items=o.all(t),void 0==t&&(l.noMoreItemsAvailable=!0)):l.noMoreItemsAvailable=!0,e.$broadcast("scroll.infiniteScrollComplete"),i.start+=2}),e.$broadcast("scroll.infiniteScrollComplete")},e.$on("$stateChangeSuccess",function(){l.loadMore()});var s=a.getDeliveryMan();null==s&&(console.log("用户没有登陆跳转到登陆界面去登陆"),t.go("signin")),l.grab=function(e,t,n,a){var i=r.confirm({title:"系统提示",template:"确定要派送此订单?",okText:"确定",cancelText:"取消"});i.then(function(i){if(i){var l={id:e,deliverymanid:s.delmanid,bzj:t,sellerid:n,buyerid:a};o.grapOrderInfo(l).then(function(t){o.remove(e);r.alert({title:"系统提示",okText:"确定",template:"抢单成功!抓紧时间派送赚钱吧!"})})}})}}]),logisticModule.controller("MyLogisticListCtrl",["$state","$scope","$http","OrderListService","UserService",function(e,t,n,r,o){var a=o.getDeliveryMan(),i=t.vm={};a||(console.log("跳到登陆界面"),e.go("signin"));var l={start:0,limit:5,deliverystate:0,deliverymanid:a.delmanid};i.orderstate=3,i.shouldShowDelete=!1,i.shouldShowReorder=!1,i.listCanSwipe=!0,i.noMoreItemsAvailable=!1,i.items=[],i.flag=!1,i.showDetailInfo=function(t){e.go("app.detail",{orderid:t})},r.clear(),i.newReceived=function(){i.noMoreItemsAvailable=!1,i.items=[],l.start=0,l.deliverystate=0,delete l.finishstate,i.orderstate=3,r.clear(),i.loadMore(3)},i.hasReceived=function(){i.noMoreItemsAvailable=!1,i.items=[],l.start=0,l.finishstate=0,l.ids="1,4",delete l.deliverystate,i.orderstate=4,r.clear(),i.loadMore(),console.log("配送中列表=====>清空数据")},i.hasDone=function(){i.noMoreItemsAvailable=!1,console.log("hasDone vm.noMoreItemsAvailable = "+i.noMoreItemsAvailable),i.items=[],l.start=0,delete l.deliverystate,delete l.ids,l.finishstate=1,i.orderstate=5,r.clear(),i.loadMore(),console.log("已完成列表=====>清空数据")},i.loadMore=function(){r.findMineDeliveryOrder(l).then(function(e){0!=e.length?i.items=r.all(e):i.noMoreItemsAvailable=!0,t.$broadcast("scroll.infiniteScrollComplete"),l.start+=5})},t.$on("$stateChangeSuccess",function(){i.loadMore(3)})}]),logisticModule.controller("DeliveryDetailCtrl",["$state","$stateParams","$ionicPopup","$scope","$http","OrderListService","OrderFlowService","UserService",function(e,t,n,r,o,a,i,l){var s=l.getDeliveryMan(),c=r.vm={},d={id:t.orderid,deliverymanid:s.delmanid};c.obj=d,c.qrcode={},a.getOrderDetail(d).then(function(e){c.qrcode.version=4,c.qrcode.level="M",c.qrcode.size=274,c.datainfo=e}),c.arriveStore=function(){i.arriveStore(d).then(function(t){if(t.success===!0){n.alert({title:"系统提示",okText:"确定",template:"操作成功!已经系统记录,请快速处理后续业务!"});e.go("app.mydeliverylist")}else{n.alert({title:"系统提示",okText:"确定",template:"操作失败!请稍后重试或联系客服!"});e.go("app.mydeliverylist")}})},c.getStuffSuccess=function(){i.getStuffSuccess(d).then(function(t){if(t.success===!0){n.alert({title:"系统提示",okText:"确定",template:"操作成功!已经系统记录,请快速处理后续业务!"});e.go("app.mydeliverylist")}else{n.alert({title:"系统提示",okText:"确定",template:"操作失败!请稍后重试或联系客服!"});e.go("app.mydeliverylist")}})},c.getStuffFailure=function(){i.getStuffFailure(d).then(function(t){if(t.success===!0){n.alert({title:"系统提示",okText:"确定",template:"操作成功!已经系统记录,请快速处理后续业务!"});e.go("app.mydeliverylist")}else{n.alert({title:"系统提示",okText:"确定",template:"操作失败!请稍后重试或联系客服!"});e.go("app.mydeliverylist")}})},c.finishSuccess=function(){i.finishSuccess(d).then(function(t){if(t.success===!0){n.alert({title:"系统提示",okText:"确定",template:"操作成功!已经系统记录,请快速处理后续业务!"});e.go("app.mydeliverylist")}else{n.alert({title:"系统提示",okText:"确定",template:"操作失败!请稍后重试或联系客服!"});e.go("app.mydeliverylist")}})},c.finishFailure=function(){i.finishFailure(d).then(function(t){if(t.success===!0){n.alert({title:"系统提示",okText:"确定",template:"操作成功!已经系统记录,请快速处理后续业务!"});e.go("app.mydeliverylist")}else{n.alert({title:"系统提示",okText:"确定",template:"操作失败!请稍后重试或联系客服!"});e.go("app.mydeliverylist")}})},c.storeTakeStuffSuccess=function(){i.storeTakeStuffSuccess(d).then(function(t){if(t.success===!0){n.alert({title:"系统提示",okText:"确定",template:"操作成功!已经系统记录,请快速处理后续业务!"});e.go("app.mydeliverylist")}else{n.alert({title:"系统提示",okText:"确定",template:"操作失败!请稍后重试或联系客服!"});e.go("app.mydeliverylist")}})},c.takeOwnStuff=function(){var t=n.show({template:'<input type="text" ng-model="vm.datainfo.verifycodenew">',title:"系统提示",subTitle:"请输入妥投失败理由",scope:r,buttons:[{text:"取消"},{text:"<b>确定</b>",type:"button-positive",onTap:function(e){return c.datainfo.verifycodenew?c.datainfo.verifycodenew:void e.preventDefault()}}]});t.then(function(t){if(t==c.datainfo.verifycode){var r={id:c.datainfo.id,orderstate:5};a.deliverySuccess(r).then(function(t){if("object"==typeof t){n.alert({title:"系统提示",okText:"确定",template:"操作成功!已经系统记录,请快速处理后续业务!"});e.go("app.mydeliverylist")}})}else{n.alert({title:"系统提示",okText:"确定",template:"验证码不对，不能妥投！"})}})}}]),angular.module("services.lp",[]).factory("OrderFlowService",["$http","$q",function(e,t){var n={},r=function(r,o){var a=function(e){return $.param(e)};return e.post(r,o,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Access-Control-Allow-Origin":"*"},transformRequest:a}).then(function(e){return angular.isObject(e.data)?n=e.data:t.reject(e.data)},function(e){return t.reject(e.data)})};return{getOrdersForTaskId:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/queryordersbytaskid.jspx";return r(t,e)},grapOrderInfo:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/graborder.jspx";return r(t,e)},arriveStore:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/arrivestore.jspx";return r(t,e)},getStuffSuccess:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/getstuffsuccess.jspx";return r(t,e)},getStuffFailure:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/getstufffailure.jspx";return r(t,e)},finishSuccess:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/deliverysuccess.jspx";return r(t,e)},finishFailure:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/deliveryfail.jspx";return r(t,e)},storeTakeStuffSuccess:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/deliverygoodback.jspx";return r(t,e)},obeyFinish:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/obeyfinish.jspx";return r(t,e)}}}]).factory("OrderListService",["$http","$q",function(e,t){var n={},r=function(r,o){var a=function(e){return $.param(e)};return e.post(r,o,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},transformRequest:a}).then(function(e){return"object"==typeof e.data?n=e.data.result:t.reject(e.data)},function(e){return t.reject(e.data)})},o=[];return{clear:function(){return o.splice(0,o.length),o=[]},remove:function(e){angular.forEach(o,function(t,n){return t.id==e?void o.splice(n,1):void 0})},all:function(e){if(void 0!=e)if(0!=e.length&&0!=o.length)for(var t=e.length-1;t>=0;t--)o.push(e[t]);else 0==o.length&&(o=e);return o},getOrderDetail:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/orderdetail.jspx";return r(t,e)},deliverySuccess:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/deliverysuccess.jspx";return r(t,e)},grapOrderInfo:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/graborder.jspx";return r(t,e)},findAllNeedOrder:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/queryorderformobile.jspx";return r(t,e)},findMineDeliveryOrder:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/querymyorderformobile.jspx";return r(t,e)}}}]).factory("DeliveryMenService",["$http","$q",function(e,t){var n={},r=function(r,o){var a=function(e){return $.param(e)};return e.post(r,o,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Access-Control-Allow-Origin":"*"},transformRequest:a}).then(function(e){return"object"==typeof e.data?n=e.data.result:t.reject(e.data)},function(e){return t.reject(e.data)})};return{findDeliveryManDetail:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/delivery/personaldetail.jspx";return r(t,e)}}}]),app.config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider","$httpProvider",function(e,t,n,r){e.state("app",{url:"/app","abstract":!0,templateUrl:"templates/ground/deliverymenu.html",controller:"MainMenuCtrl"}).state("app.needlist",{url:"/needlist",views:{"todo-tab":{templateUrl:"templates/logistics/lpneedlist.html",controller:"ToDoListCtrl"}}}).state("app.map",{url:"/map/:taskid",views:{"todo-tab":{templateUrl:"templates/logistics/map.html",controller:"MapInfoCtrl"}}}).state("app.ordermap",{url:"/ordermap/:orderid",views:{"todo-tab":{templateUrl:"templates/logistics/ordermap.html"}}}).state("app.taskorderlist",{url:"/taskorderlist/:taskid/:option",views:{"todo-tab":{templateUrl:"templates/logistics/orderlist.html",controller:"OrderForTaskIdListCtrl"}}}).state("app.mydeliverylist",{url:"/mydeliverylist",views:{"doing-tab":{templateUrl:"templates/logistics/mydeliverylist.html",controller:"MyLogisticListCtrl"}}}).state("app.detail",{url:"/deliverydetail/:orderid",views:{"doing-tab":{templateUrl:"templates/logistics/detail.html",controller:"DeliveryDetailCtrl"}}}).state("app.mytasks",{url:"/mytask",views:{"mytask-tab":{templateUrl:"templates/logistics/mytasks.html",controller:"MyTasksCtrl"}}}).state("app.mine",{url:"/minepanel",views:{"minedelv-tab":{templateUrl:"templates/logistics/mine.html",controller:"MineCtrl"}}}).state("app.mineinfo",{url:"/mineinfo",views:{"minedelv-tab":{templateUrl:"templates/personal/mydetail.html",controller:"MineInfoCtrl"}}}).state("app.account",{url:"/account",views:{"minedelv-tab":{templateUrl:"templates/personal/accountinfo.html",controller:"AccountInfoCtrl"}}}).state("app.companymessage",{url:"/companymessage",views:{"minedelv-tab":{templateUrl:"templates/personal/companymessage.html",controller:"CompanyMessageInfoCtrl"}}}).state("app.changecompany",{url:"/changecompany",views:{"minedelv-tab":{templateUrl:"templates/personal/changecompany.html",controller:"ChangeCompanyCtrl"}}}).state("app.signoutcompany",{url:"/signoutcompany",views:{"minedelv-tab":{templateUrl:"templates/personal/signoutcompany.html",controller:"SignOutCompanyCtrl"}}}).state("signin",{url:"/signin",templateUrl:"templates/logistics/login.html",controller:"SignInCtrl"}).state("signup",{url:"/signup",templateUrl:"templates/logistics/register.html",controller:"SignUpCtrl"}).state("findpassword",{url:"/findpass",templateUrl:"templates/logistics/findpassword.html",controller:"FindPassCtrl"}),t.otherwise("/app/needlist")}]);var tasksModule=angular.module("TasksModule",[]);tasksModule.controller("MyTasksCtrl",["$stateParams","$state","$scope","UserService","OrderFlowService","TaskService","OrderListService",function(e,t,n,r,o,a,i){var l=n.vm={},s=r.getDeliveryMan();console.log("我的任务单信息!");var c={start:0,limit:5,delmanid:s.delmanid,status:0};l.noMoreItemsAvailable=!1,l.loadMore=function(){a.queryMyTask(c).then(function(e){e.success?l.items=a.all(e.result):l.noMoreItemsAvailable=!0,c.start+=5}),n.$broadcast("scroll.infiniteScrollComplete")},l.showDoingTasks=function(){a.clear(),c={start:0,limit:5,delmanid:s.delmanid,status:0},angular.isArray(l.items)&&l.items.splice(0,l.items.length),l.loadMore()},l.showFinishTasks=function(){a.clear(),c={start:0,limit:5,delmanid:s.delmanid,status:1},angular.isArray(l.items)&&l.items.splice(0,l.items.length),l.loadMore()},n.$on("$stateChangeSuccess",function(){console.log("当进入到该窗体后,调用vm.loadMore数据信息"),a.clear(),l.loadMore()}),l.showTaskDetail=function(e){t.go("app.taskorderlist",{taskid:e,option:1})}}]),tasksModule.controller("OrderForTaskIdListCtrl",["$ionicPopup","$stateParams","$state","$scope","UserService","OrderFlowService","TaskService","OrderListService",function(e,t,n,r,o,a,i,l){console.log("进入到根据任务ID获取运单信息列表界面");var s=r.vm={};s.id=t.taskid,console.log("-进入到根据任务ID获取运单信息列表界面------------------>"+s.id),s.option=t.option,s.loadOrderByTaskId=function(){var e=o.getDeliveryManLocation(),n=t.taskid,r=t.option;console.log("option======>"+r);var i={id:n,longitude:e.longitude,latitude:e.latitude};a.getOrdersForTaskId(i).then(function(e){e.success&&(s.orders=e.result)})},s.loadOrderByTaskId(),s.isShow=function(e,t){var n={id:e};l.getOrderDetail(n).then(function(e){return s.orders[t].goods=e.goods,angular.isUndefined(s.orders[t].show)?s.orders[t].show=!0:s.orders[t].show=!s.orders[t].show,e})},s.showOrderMap=function(e){n.go("app.ordermap",{orderid:e})},s.finishOrder=function(t){var r=o.getDeliveryMan(),a=0;if(angular.forEach(s.orders,function(e,t){0==e.finishstate&&a++}),a>0)return void e.alert({title:"系统提示",okText:"确定",template:"还有"+a+"个未完成的运单,无法结束此任务!"});var l={delmanid:r.delmanid,id:t};i.finishTask(l).then(function(t){return t.success?(console.log("进行完成运单操作!"),e.alert({title:"系统提示",okText:"确定",template:"此任务成功结束!"}),void n.go("app.mytasks")):void 0})},s.grabOrder=function(t){var n=o.getDeliveryMan(),r={id:t,delmanid:n.delmanid};i.grabTask(r).then(function(t){t.success?e.alert({title:"系统提示",okText:"确定",template:"抢单成功!到已抢单中去查看具体运单任务吧!"}):"10"==t.code?e.alert({title:"系统提示",okText:"确定",template:"该任务已经被其他人领取!"}):"-1"==t.code?e.alert({title:"系统提示",okText:"确定",template:"您对该任务已经领取成功!"}):e.alert({title:"系统提示",okText:"确定",template:"抢单失败,请稍后重试!"})})}}]),tasksModule.controller("ToDoListCtrl",["$ionicPopup","$state","$scope","$http","UserService","TaskService",function(e,t,n,r,o,a){console.log("我要抢单数据!");var i=o.getDeliveryManLocation(),l=n.vm={},s={start:0,limit:5,latitude:i.latitude,longitude:i.longitude};l.noMoreItemsAvailable=!1,a.clear(),l.loadMore=function(){a.queryTaskForMobile(s).then(function(e){e.success?l.items=a.all(e.result):l.noMoreItemsAvailable=!0,s.start+=5}),n.$broadcast("scroll.infiniteScrollComplete")},n.$on("$stateChangeSuccess",function(e){a.clear(),l.loadMore()}),l.getDetail=function(e){t.go("app.map",{taskid:e})},l.showOrderList=function(e){t.go("app.taskorderlist",{taskid:e,option:0})},l.grabOrder=function(t){var n=o.getDeliveryMan(),r={id:t,delmanid:n.delmanid};a.grabTask(r).then(function(t){t.success?e.alert({title:"系统提示",okText:"确定",template:"抢单成功!到已抢单中去查看具体运单任务吧!"}):"10"==t.code?e.alert({title:"系统提示",okText:"确定",template:"该任务已经被其他人领取!"}):"-1"==t.code?e.alert({title:"系统提示",okText:"确定",template:"您对该任务已经领取成功!"}):e.alert({title:"系统提示",okText:"确定",template:"抢单失败,请稍后重试!"})})}}]),tasksModule.controller("MapInfoCtrl",["$timeout","$state","$scope","$stateParams","$http","UserService","TaskService",function(e,t,n,r,o,a,i){console.log("地图信息!");n.vm={}}]),angular.module("services.taskservice",[]).factory("TaskService",["$http","$q",function(e,t){var n={},r=function(r,o){var a=function(e){return $.param(e)};return e.post(r,o,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Access-Control-Allow-Origin":"*"},transformRequest:a}).then(function(e){return angular.isObject(e.data)?n=e.data:t.reject(e.data)},function(e){return t.reject(e.data)})},o=[];return{finishTask:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/finishtask.jspx";return r(t,e)},queryMyTask:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/querymytask.jspx";return r(t,e)},grabTask:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/grabtask.jspx";return r(t,e)},setTasks:function(e){e=e},clear:function(){return o.splice(0,o.length),o=[]},all:function(e){if(void 0!=e)if(0!=e.length&&0!=o.length)for(var t=e.length-1;t>=0;t--)o.push(e[t]);else 0==o.length&&(o=e);return o},queryTaskForDetail:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/queryordersbytaskid.jspx";return r(t,e)},queryTaskForMobile:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/orderconsole/querytaskformobile.jspx";return r(t,e)},setUserInfo:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/delivery/updatemaninfo.jspx";return r(t,e)}}}]);var userModule=angular.module("UserModule",[]);userModule.controller("MineCtrl",["$state","$scope","$timeout","$cordovaAppVersion","$cordovaFile","$cordovaFileOpener2","$cordovaFileTransfer","$ionicPopup","$ionicLoading","UserService",function(e,t,n,r,o,a,i,l,s,c){var d=t.vm={},u=c.getDeliveryMan();d.user={},d.user.name=u.phone,d.signOut=function(){localStorage.removeItem("deliveryman");var t=c.getDeliveryMan();t||e.go("signin")},window.checkUpdate=function(){var e="0.0.5",t={};c.getVersion(t).then(function(t){t.success?(e=t.result.name,r.getAppVersion().then(function(n){if(n!=e){var r=t.result.content;showUpdateConfirm(r)}else alert("已经是最新的"+e+"版本")})):alert("未发现新版本!")})},window.showUpdateConfirm=function(e){var t=l.confirm({title:"版本升级",template:e,cancelText:"取消",okText:"升级"});t.then(function(e){if(e){s.show({template:"已经下载：0%"});var t="http://joke.qhdsx.com/youhuicms/android-debug.apk",r="file:///storage/sdcard0/Download/lpog.apk",o=!0,l={};i.download(t,r,l,o).then(function(e){a.open(r,"application/vnd.android.package-archive").then(function(){},function(e){}),s.hide()},function(e){},function(e){n(function(){var t=e.loaded/e.total*100;s.show({template:"已经下载："+Math.floor(t)+"%"}),t>99&&s.hide()})})}})},d.checkNew=function(){try{checkUpdate()}catch(e){alert(e.description)}}}]),userModule.controller("MineInfoCtrl",["$state","$scope","$http","$ionicPopup","UserService",function(e,t,n,r,o){var a=t.vm={},i=o.getDeliveryMan();i||e.go("signin"),a.loadDetail=function(){a.man={head:"img/images/caojian.jpg",name:i.phone,complatenum:1050,successnum:1032,createtime:"2015-08-01",companyname:"丹旌物流公司",phone:i.phone,idcard:"220********1818"},i.name?a.man.name=i.name:a.man.name=i.phone},a.loadDetail(),a.showNameBox=function(){var e=r.show({template:'<input type="text" ng-model="vm.man.name">',title:"系统提示",subTitle:"请输入要修改的名称!",scope:t,buttons:[{text:"取消"},{text:"<b>确定</b>",type:"button-positive",onTap:function(e){return a.man.name?a.man.name:void e.preventDefault()}}]});e.then(function(e){var t={delmanid:i.delmanid,name:e};o.setUserInfo(t).then(function(t){if(angular.isObject(t)){i.name=e;var n=JSON.stringify(i);localStorage.setItem("deliveryman",n);r.alert({title:"系统提示",okText:"确定",template:"姓名修改成功!"})}else{r.alert({title:"系统提示",okText:"确定",template:"姓名修改失败!"})}})})}}]),userModule.controller("AccountInfoCtrl",["$state","$scope","$http","UserService",function(e,t,n,r){var o=t.vm={},a=r.getDeliveryMan();a||e.go("signin"),o.items=[{month:"2015-07",amount:200},{month:"2015-06",amount:190},{month:"2015-05",amount:180},{month:"2015-04",amount:170},{month:"2015-03",amount:160},{month:"2015-01",amount:150}]}]),userModule.controller("CompanyMessageInfoCtrl",["$state","$scope","$http","UserService",function(e,t,n,r){var o=t.vm={},a=r.getDeliveryMan();a||e.go("signin"),o.items=[{date:"2015-07-01",title:"还没绑账号的小伙伴注意啦！"},{date:"2015-06-23",title:"公司打款账号通知"},{date:"2015-05-25",title:"绑定个人支付宝账号须知"},{date:"2015-04-28",title:"雨季突发，提醒大家携带雨具"},{date:"2015-03-29",title:"春节将至,祝大家节日快乐"},{date:"2015-01-31",title:"欢迎你加入众包平台"}]}]),userModule.controller("ChangeCompanyCtrl",["$state","$scope","$http","UserService",function(e,t,n,r){var o=t.vm={},a=r.getDeliveryMan();a||e.go("signin"),o.items=[{name:"2015-07-01",title:"还没绑账号的小伙伴注意啦！"},{name:"2015-06-23",title:"公司打款账号通知"},{name:"2015-05-25",title:"绑定个人支付宝账号须知"},{name:"2015-04-28",title:"雨季突发，提醒大家携带雨具"},{name:"2015-03-29",title:"春节将至,祝大家节日快乐"},{name:"2015-01-31",title:"欢迎你加入众包平台"}]}]),userModule.controller("SignOutCompanyCtrl",["$state","$scope","$http","UserService",function(e,t,n,r){var o=t.vm={},a=r.getDeliveryMan();a||e.go("signin"),o.items=[{name:"2015-07-01",title:"还没绑账号的小伙伴注意啦！"},{name:"2015-06-23",title:"公司打款账号通知"},{name:"2015-05-25",title:"绑定个人支付宝账号须知"},{name:"2015-04-28",title:"雨季突发，提醒大家携带雨具"},{name:"2015-03-29",title:"春节将至,祝大家节日快乐"},{name:"2015-01-31",title:"欢迎你加入众包平台"}]}]),angular.module("services.user",[]).factory("UserService",["$http","$q",function(e,t){var n=!1,r={},o=function(n,o){var a=function(e){return $.param(e)};return e.post(n,o,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Access-Control-Allow-Origin":"*"},transformRequest:a}).then(function(e){return angular.isObject(e.data)?r=e.data:t.reject(e.data)},function(e){return t.reject(e.data)})};return{setPostManLocation:function(){var e=this.getDeliveryMan();if(e){var t=new BMap.Geolocation;t.getCurrentPosition(function(t){if(this.getStatus()==BMAP_STATUS_SUCCESS){var n=t.point.lng,r=t.point.lat,a=e.delmanid,i={delmanid:a,longitude:n,latitude:r},l=window.YOU_HUI_BaseUrl+"/lp/delivery/updatemanlocation.jspx";o(l,i).then(function(e){e.success&&(console.log("====success===="),localStorage.setItem("deliverymanlocation",JSON.stringify(e.result)))})}},{enableHighAccuracy:!0})}},getDeliveryManLocation:function(){var e=localStorage.getItem("deliverymanlocation");if(e){var t=JSON.parse(e);return t}return null},getVersion:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/version/getlatestversion.jspx";return o(t,e)},setUserInfo:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/delivery/updatemaninfo.jspx";return o(t,e)},getDeliveryMan:function(){var e=localStorage.getItem("deliveryman");if(e){var t=JSON.parse(e);return t}return null},findPhoneOnly:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/delivery/findphoneonly.jspx";return o(t,e)},sendSms:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/delivery/sendsms.jspx";return o(t,e)},getPassWord:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/delivery/getpass.jspx";return o(t,e)},signIn:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/delivery/signin.jspx";return o(t,e)},signUp:function(e){var t=window.YOU_HUI_BaseUrl+"/lp/delivery/signup.jspx";return o(t,e)},makeOrderInfo:function(n){var o=window.YOU_HUI_BaseUrl+"/store/order/makeorder.jspx",a=function(e){return $.param(e)};return e.post(o,n,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Access-Control-Allow-Origin":"*"},transformRequest:a}).then(function(e){return"object"==typeof e.data?r=e.data.result:t.reject(e.data)},function(e){return t.reject(e.data)})},getMineCartInfo:function(n){var r={},o=window.YOU_HUI_BaseUrl+"/store/cart/findshopcarbyuserid.jspx",a=function(e){return $.param(e)};return e.post(o,n,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Access-Control-Allow-Origin":"*"},transformRequest:a}).then(function(e){return"object"==typeof e.data?r=e.data.result:t.reject(e.data)},function(e){return t.reject(e.data)})},goToWeixinPay:function(n,r){var o=(window.YOU_HUI_BaseUrl+"/weixin/makeopenidurl.jspx",function(e){return $.param(e)});return e.post(n,r,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Access-Control-Allow-Origin":"*"},transformRequest:o}).then(function(e){return e.data},function(e){return t.reject(e.data)})},makeWeixinPayOrder:function(n){var r=window.YOU_HUI_BaseUrl+"/weixin/makeopenidurl.jspx",o=function(e){return $.param(e)};return e.post(r,n,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","Access-Control-Allow-Origin":"*"},transformRequest:o}).then(function(e){return e.data},function(e){return t.reject(e.data)})},makeAliPayOrder:function(n){
var r=window.YOU_HUI_BaseUrl+"/store/order/makealipaybill.jspx",o=function(e){return $.param(e)};return e.post(r,n,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},transformRequest:o}).then(function(e){return e.data},function(e){return t.reject(e.data)})},getConsumer:function(){var e=localStorage.getItem("consumer");if(e){var t=JSON.parse(e);return t}return null},setShowuserheader:function(e){this.showuserheader=e},getShowuserheader:function(){return n},userlogin:function(n){var r={},o=window.YOU_HUI_BaseUrl+"/user/info/consumerlogin.jspx",a=function(e){return $.param(e)};return e.post(o,n,{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},transformRequest:a}).then(function(e){return"object"==typeof e.data?r=e.data.result:t.reject(e.data)},function(e){return t.reject(e.data)})}}}]);